(function(a) {
    a.fn.drag = function(c) {
        var b = {
            handler: false,
            mousedown: a.noop,
            mousemove: a.noop,
            mouseup: a.noop
        };
        var d = a.extend(b, c);
        this.each(function() {
            var l = false,
                k = d.handler ? a(this).find(d.handler) : a(this),
                e = a(this),
                g, h, i, j, f = {
                    left: 0,
                    top: 0
                };
            k.on("touchmove", function(n) {
                if (l) {
                    n = n.originalEvent || n;
                    i = n.targetTouches[0].pageX;
                    j = n.targetTouches[0].pageY;
                    var o = i - g,
                        p = j - h;
                    f = {
                        left: o,
                        top: p
                    };
                    d.mousemove.call(e, o, p);
                    n.preventDefault()
                }
            }).on("touchend", function(n) {
                n = n.originalEvent || n;
                l = false;
                d.mouseup.call(e, f, i - g, j - h)
            }).on("touchstart", function(n) {
                n = n.originalEvent || n;
                if (a(n.currentTarget).is(k)) {
                    l = true;
                    g = n.targetTouches[0].pageX - parseInt(e.css("left"));
                    h = n.targetTouches[0].pageY - parseInt(e.css("top"))
                }
            })
        })
    }
})(jQuery);

function randomInt(b, a) {
    return Math.floor(Math.random() * (a - b) + b)
}
var meteor = function(b) {
    var e = window.screen.width,
        d = window.screen.height,
        f = [e * 0.65, e * 0.6, e * 0.55],
        g = [d * 0.02, d * 0.6, d * 0.08],
        a = [40, 45, 50],
        c = [4, 6, 8];
    this.x = f[randomInt(0, 3)];
    this.y = g[randomInt(0, 3)];
    this.length = 20;
    this.width = 1;
    this.speed = 16;
    this.angle = 25;
    this.alpha = 1;
    this.countPos = function() {
        this.x = this.x - this.speed * Math.cos(this.angle * 3.14 / 180);
        this.y = this.y + this.speed * Math.sin(this.angle * 3.14 / 180)
    };
    this.drawSingleMeteor = function() {
        b.save();
        b.beginPath();
        b.lineWidth = this.width;
        b.globalAlpha = this.alpha;
        var h = b.createLinearGradient(this.x, this.y, this.x + this.length * Math.cos(this.angle * 3.14 / 180), this.y - this.length * Math.sin(this.angle * 3.14 / 180));
        h.addColorStop(0, "white");
        h.addColorStop(1, "black");
        b.strokeStyle = h;
        b.moveTo(this.x, this.y);
        b.lineTo(this.x + this.length * Math.cos(this.angle * 3.14 / 180), this.y - this.length * Math.sin(this.angle * 3.14 / 180));
        b.closePath();
        b.stroke();
        b.restore()
    }
};

function loadImages(d, a) {
    a = a || $.noop;
    var e = d.length,
        b = 0,
        f = [];
    for (var c in d) {
        f[c] = new Image();
        if (f[c].complete) {
            if (++b >= e) {
                a.call(f)
            }
        } else {
            f[c].onload = function() {
                f[c].onload = null;
                if (++b >= e) {
                    a.call(f)
                }
            }
        }
        f[c].src = d[c]
    }
}
var canvas = document.getElementById("canvas");
var cxt = canvas.getContext("2d");
var m = new meteor(cxt);
var timer = null;
var meteorTime = 100;

function playMeteors() {
    var b = m.speed * Math.cos(m.angle * 3.14 / 180);
    var a = m.speed * Math.sin(m.angle * 3.14 / 180);
    cxt.clearRect(m.x + m.length * Math.cos(m.angle * 3.14 / 180) - 6 * b, m.y - m.length * Math.sin(m.angle * 3.14 / 180) - 6 * a, 10 * b, 10 * a);
    if (m.x < -m.length || m.alpha <= 0.01) {
        clearInterval(timer);
        m = new meteor(cxt);
        setTimeout(function() {
            timer = setInterval(playMeteors, meteorTime)
        }, 3000)
    } else {
        m.drawSingleMeteor();
        m.countPos();
        m.alpha -= 0.002
    }
}
$(window).load(function() {
    loadImages(["images/arrows.png", "images/index_captions.png", "images/index_product.png", "images/index_logo.png", "images/1.png", "images/2.gif", "images/3.gif", "images/caption_6-1.png", "images/caption_6-2_1.png", "images/caption_6-2_2.png", "images/caption_6-3.png", "images/caption1.png", "images/caption2.png", "images/caption3.png", "images/caption4.png", "images/ditu.png", "images/tidu_btn.png", "images/ditu_img_1.png", "images/ditu_img_2.png", "images/ditu_img_3.png", "images/haiwaidaigou.png", "images/halo.png", "images/halo_big.png", "images/halo_small.png", "images/img_box.png", "images/ljty.png", "images/ljty1.png", "images/product_1.png", "images/product_3.png", "images/product_4.png", "images/sanitary_napkins_1.png", "images/sanitary_napkins_2.png", "images/sanitary_napkins_3.png", "images/tips_1.png", "images/tips_3.png", "images/tips_4.png", "images/footer.png"], function() {
        $("#container").show();
        $("#loading").hide();
        timer = setInterval(playMeteors, meteorTime);
        animation()
    })
});

function animation() {
    var a, b;
    $("[data-animation]").each(function() {
        $(this).css({
            "-webkit-animation": "none",
            animation: "none",
            display: "none"
        })
    });
    $("#container>section.current").find("[data-animation]").each(function() {
        a = $(this);
        b = a.data("animation") + " " + a.data("duration") + "ms ease " + a.data("delay") + "ms both";
        $(this).css({
            "-webkit-animation": b,
            animation: b,
            display: "block"
        })
    })
}
$(function() {
    var b = null,
        a = 0;
    $("#container>section").drag({
        mousedown: function() {
            this.css({
                "-webkit-transform": "translateY(0px)",
                transform: "translateY(0px)"
            })
        },
        mousemove: function(e, f) {
            if (this.height() < this.children().height() && (a + f) < 0) {
                if (this.children().height() + a + f > $(window).height()) {
                    var c = a + f;
                    this.children().css({
                        "-webkit-transform": "matrix(1, 0, 0, 1, 0, " + c + ")",
                        transform: "matrix(1, 0, 0, 1, 0, " + c + ")"
                    })
                }
            } else {
                if (f < -50) {
                    b = "next"
                } else {
                    if (f > 50) {
                        b = "prev";
                        a = 0
                    } else {
                        b = null
                    }
                }
                this.css({
                    "-webkit-transform": "translateY(" + f + "px)",
                    transform: "translateY(" + f + "px)"
                });
                var d = this.outerHeight(true) + f;
                if (f < 0 && this.next("section").length) {
                    this.next("section").css({
                        "-webkit-transform": "translateY(" + d + "px)",
                        transform: "translateY(" + d + "px)"
                    })
                } else {
                    if (f > 0 && this.prev("section").length) {
                        this.prev("section").css({
                            "-webkit-transform": "translateY(-" + d + "px)",
                            transform: "translateY(-" + d + "px)"
                        })
                    }
                }
            }
        },
        mouseup: function(c, d, e) {
            if (this.height() < this.children().height()) {
                if (this.children().height() + a + e > $(window).height()) {
                    a += e
                } else {
                    a = $(window).height() - this.children().height()
                }
            }
            if (b === "next" && this.next("section").length) {
                this.css({
                    "-webkit-transform": "translateY(-" + this.outerHeight(true) + "px)",
                    transform: "translateY(-" + this.outerHeight(true) + "px)"
                }).removeClass("current");
                this.next("section").css({
                    "-webkit-transform": "translateY(0px)",
                    transform: "translateY(0px)"
                }).addClass("current");
                setTimeout(animation, 300)
            } else {
                if (b === "prev" && this.prev("section").length) {
                    this.css({
                        "-webkit-transform": "translateY(" + this.outerHeight(true) + "px)",
                        transform: "translateY(" + this.outerHeight(true) + "px)"
                    }).removeClass("current");
                    this.prev("section").css({
                        "-webkit-transform": "translateY(0px)",
                        transform: "translateY(0px)"
                    }).addClass("current");
                    setTimeout(animation, 300)
                } else {
                    this.css({
                        "-webkit-transform": "translateY(0px)",
                        transform: "translateY(0px)"
                    });
                    if (c.top > 0 && this.prev("section").length) {
                        this.prev("section").css({
                            "-webkit-transform": "translateY(-" + this.outerHeight(true) + "px)",
                            transform: "translateY(-" + this.outerHeight(true) + "px)"
                        })
                    } else {
                        if (c.top < 0 && this.next("section").length) {
                            this.next("section").css({
                                "-webkit-transform": "translateY(" + this.outerHeight(true) + "px)",
                                transform: "translateY(" + this.outerHeight(true) + "px)"
                            })
                        }
                    }
                }
            }
            b = null;
            return false
        }
    });
    WeixinApi.ready(function(c) {
        var d = ["护舒宝28年憋出大招！全球首款液体卫生巾正式登陆", "抢先试用全球首款液体卫生巾"];
        c.showOptionMenu();
        var f = {
            appId: "",
            imgUrl: "images/share_img.jpg",
            link: "http://t.cn/Rzt4Lzf",
            desc: d[randomInt(0, 2)],
            title: "宝洁生活家"
        };
        var e = {
            ready: function() {},
            cancel: function(g) {},
            fail: function(g) {},
            confirm: function(g) {},
            all: function(g) {}
        };
        c.shareToFriend(f, e);
        c.shareToTimeline(f, e);
        c.shareToWeibo(f, e)
    })
});